<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>WebChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
body {
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system, BlinkMacSystemFont;
}
header {
  text-align:center;
  padding:12px 0 4px;
  font-size:20px;
  font-weight:600;
}
#count {
  text-align:center;
  color:#888;
  font-size:13px;
}
#messages {
  padding:10px;
  padding-bottom:90px;
}
.msg {
  max-width:70%;
  padding:10px 14px;
  border-radius:18px;
  margin:6px 0;
  word-break:break-word;
}
.me { margin-left:auto; background:#0A84FF; }
.you { background:#2C2C2E; }
#typing {
  color:#888;
  font-size:13px;
  padding:0 14px;
}

/* footer */
footer {
  position:fixed;
  bottom:env(safe-area-inset-bottom);
  left:0;
  width:100%;
  display:flex;
  gap:8px;
  padding:10px;
  background:#000;
  box-sizing:border-box;
}
#input {
  flex:1;
  height:44px;
  border:none;
  border-radius:22px;
  padding:0 14px;
  font-size:16px;
  outline:none;
}
#sendBtn {
  height:44px;
  min-width:64px;
  border:none;
  border-radius:22px;
  background:#4f46e5;
  color:#fff;
  font-size:15px;
}

/* password overlay */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.hidden { display:none; }
.password-box {
  width:90%;
  max-width:320px;
  background:#111;
  border-radius:16px;
  padding:20px;
  text-align:center;
}
.password-box h2 { margin-bottom:12px; font-size:18px; }
#pwInput {
  width:100%;
  height:44px;
  border-radius:22px;
  padding:0 14px;
  font-size:16px;
  margin-bottom:12px;
}
#pwBtn {
  width:100%;
  height:44px;
  border-radius:22px;
  background:#1ed760;
  color:#000;
  font-weight:bold;
}
#pwError {
  margin-top:10px;
  color:#ff5c5c;
  font-size:14px;
}
</style>
</head>

<body>

<!-- ì•”í˜¸ ìž…ë ¥ UI -->
<div id="pwOverlay" class="overlay hidden">
  <div class="password-box">
    <h2>ðŸ”’ ì•”í˜¸ê°€ í•„ìš”í•œ ë°©</h2>
    <input id="pwInput" type="password" placeholder="ì•”í˜¸ ìž…ë ¥">
    <button id="pwBtn">ìž…ìž¥</button>
    <div id="pwError"></div>
  </div>
</div>

<header>WebChat</header>
<div id="count"></div>
<div id="messages"></div>
<div id="typing"></div>

<footer>
  <input id="input" placeholder="Message">
  <button id="sendBtn">ë³´ë‚´ê¸°</button>
</footer>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyBONHZ5CmDrvoQ4q8sx_f5g0EiEJGJw_1s",
  authDomain: "webchat-841e0.firebaseapp.com",
  projectId: "webchat-841e0",
  storageBucket: "webchat-841e0.firebasestorage.app",
  messagingSenderId: "772656579197",
  appId: "1:772656579197:web:92055fafce079bd6cc6714"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* params */
const p = new URLSearchParams(location.search);
const roomId = p.get("room");
const maxUsers = Number(p.get("max")) || 2;
const isTemp = p.get("type")==="temp";
const hashPw = location.hash.slice(1);

/* DOM */
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const typingEl = document.getElementById("typing");
const countEl = document.getElementById("count");

/* password UI */
const overlay = document.getElementById("pwOverlay");
const pwInput = document.getElementById("pwInput");
const pwBtn = document.getElementById("pwBtn");
const pwError = document.getElementById("pwError");

let uid, nickname;
const roomRef = db.collection("rooms").doc(roomId);

/* nickname */
function askNickname(){
  const r=/^[ê°€-íž£a-zA-Z]{1,10}$/;
  let n;
  do{ n=prompt("ë‹‰ë„¤ìž„ (í•œ/ì˜ 10ìž)"); }while(!r.test(n));
  localStorage.setItem("nickname",n);
  return n;
}

/* password UI logic */
if(hashPw){
  const saved = localStorage.getItem("room_pw_"+roomId);
  if(saved!==hashPw) overlay.classList.remove("hidden");
}
pwBtn.onclick = ()=>{
  if(pwInput.value===hashPw){
    localStorage.setItem("room_pw_"+roomId,hashPw);
    overlay.classList.add("hidden");
  } else {
    pwError.textContent="ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤";
    pwInput.value="";
  }
};
pwInput.onkeydown=e=>{ if(e.key==="Enter") pwBtn.click(); };

/* auth */
auth.signInAnonymously().then(async r=>{
  uid=r.user.uid;
  nickname=localStorage.getItem("nickname")||askNickname();

  const ok = await db.runTransaction(async tx=>{
    const s=await tx.get(roomRef);
    const m=s.data()?.meta||{};
    if((m.usersCount||0)>=(m.maxUsers||maxUsers)) return false;
    tx.set(roomRef,{meta:{
      ...m,
      usersCount:(m.usersCount||0)+1,
      maxUsers:m.maxUsers||maxUsers,
      temp:isTemp
    }},{merge:true});
    return true;
  });

  if(!ok){ alert("ì¸ì› ì´ˆê³¼"); location.href="index.html"; return; }
  listen();
});

/* listeners */
function listen(){
  roomRef.collection("messages").orderBy("time").onSnapshot(s=>{
    messages.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.uid===uid?"me":"you");
      div.textContent=m.text;
      messages.appendChild(div);
    });
    window.scrollTo(0,document.body.scrollHeight);
  });

  roomRef.collection("users").onSnapshot(s=>{
    let t=false;
    s.forEach(d=>{ if(d.id!==uid && d.data().typing) t=true; });
    typingEl.textContent=t?"â€¦":"";
  });

  roomRef.onSnapshot(d=>{
    const m=d.data()?.meta;
    if(!m) return;
    countEl.textContent=`${m.usersCount} / ${m.maxUsers}`;
    if(m.temp && m.usersCount<=0) roomRef.delete();
  });
}

/* send */
function send(){
  const text=input.value.trim();
  if(!text) return;
  roomRef.collection("messages").add({
    text, uid,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  input.value="";
}
sendBtn.onclick=send;
input.onkeydown=e=>{ if(e.key==="Enter") send(); };
input.oninput=()=>{
  roomRef.collection("users").doc(uid)
    .set({nickname,typing:true},{merge:true});
  clearTimeout(window._t);
  window._t=setTimeout(()=>{
    roomRef.collection("users").doc(uid).update({typing:false});
  },1000);
};

/* leave */
window.addEventListener("beforeunload",()=>{
  roomRef.collection("users").doc(uid).delete();
  roomRef.update({
    "meta.usersCount":firebase.firestore.FieldValue.increment(-1)
  });
});
</script>

</body>
</html>
